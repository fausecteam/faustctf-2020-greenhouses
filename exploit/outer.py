#!/usr/bin/env python3

import os
import dbus
import sys
import signal

from dbus.types import UnixFd
from dbus.mainloop.glib import DBusGMainLoop
from gi.repository import GLib

sys.path.append("/opt/bin")
from sudod import getClient, SERVICE_NAME, SERVICE_INTERFACE, GUARD_INTERFACE

import pwd, grp

as_user = pwd.getpwuid(os.getuid()).pw_name
as_group = grp.getgrgid(os.getgid()).gr_name

DBusGMainLoop(set_as_default=True)

system_bus = dbus.SystemBus()
#print("i am",system_bus.get_unique_name())

c = getClient(system_bus)

cwdfd = os.open(".", os.O_RDONLY)
dbus_cwd = UnixFd(cwdfd)
os.close(cwdfd)



loop = GLib.MainLoop()


peer = c.createSession(["./inner.py"], as_user, as_group)
peer = system_bus.get_object(peer, "/guard")
peer = dbus.Interface(peer, GUARD_INTERFACE)

peer.simpleAuth()

peer.chdirFD(dbus_cwd)



for fd in range(3):
    x = peer.connectFD(UnixFd(fd))
    peer.dupFD(x, fd)
    peer.closeFD(x)

peer.dupFD(4, 42)


def on_exit(status):
    # relay exit info by dying the same way
    if os.WIFEXITED(status):
        os._exit(os.WEXITSTATUS(status))
    if os.WIFSIGNALED(status):
        sig = os.WTERMSIG(status)
        try:
            signal.signal(sig, signal.SIG_DFL)
        except OSError: # KILL or STOP, they work anyways
            pass
        os.kill(os.getpid(), os.WTERMSIG(status))
    os.exit(1)

peer.connect_to_signal("exited", on_exit)

peer.run()
loop.run()
